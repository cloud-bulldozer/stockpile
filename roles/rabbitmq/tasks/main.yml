---

- name : Get rabbitmq file descriptors
  shell: rabbitmqctl status | grep file_descriptors | awk -F',' '{print $3}' | sed 's/.$//'
  register: rabbitmq_desc
  ignore_errors: true
  when: hostvars[inventory_hostname]['containers'] is not defined

- name: Set rabbitmq file descriptors
  set_fact:
    stockpile_openstack_rabbitmq:
      file_descriptors: "{{ rabbitmq_desc.stdout }}"
  when: rabbitmq_desc is succeeded

- name : Get rabbitmq file descriptors - containers
  shell: docker exec rabbitmq rabbitmqctl status | grep total_limit | awk -F',' '{print $2}'| sed 's/.$//'
  register: rabbitmq_desc
  ignore_errors: true
  when: hostvars[inventory_hostname]['containers'] is defined

- name: Set rabbitmq file descriptors
  set_fact:
    stockpile_openstack_rabbitmq:
      file_descriptors: "{{ rabbitmq_desc.stdout }}"
  when: rabbitmq_desc is succeeded
